第8讲 视觉里程计：直接法

8.4 与特征点法的比较
	特征点法中，为了估计相机的运动，我们通过提取特征点，根据它们在相机中的投影位置，通过最小化重投影误差（Reprojection Error）优化相机的位姿。在这一过程中，我们需要清楚地知道相机间关键点的精确位置，从而进行下一步特征匹配。在这一过程中，需要大量的计算量。而在直接法中，并不需要知道点与点的对应关系，只需要根据关键点的像素的亮度，通过最小化光度误差（Photometric Error）进行相机运动矩阵的优化。

8.5  光流法的不足
	光流法仅估计了像素间的平移，但：
	没有考虑到相机本身的几何结构，
	没有考虑到相机的旋转和图像的缩放；
	对于边界处的点，光流不好追踪；
	直接法则考虑了这些信息；

8.5  直接法原理
	在特征点法中，首先会计算关键点，再进行关键点的匹配，从而估计相机的运动；在光流法中，首先计算关键点，追踪关键点的位置，再根据关键点的位置估计相机的运动。直接法则不同，直接法根据像素的亮度信息直接估计相机的运动，可以完全不用计算关键点和描述子。这样既避免了特征的计算时间，也避免了特征匹配缺失的情况。只要场景中存在明暗变化，直接法就能工作。另外，特征点法只能重构稀疏特征点，直接法还能恢复稠密和半稠密结构；直接法不用提取特征点（比如角点），对于角点数量较少的情况也可以适用（对于白色墙体效果非常好）；对于比如物体边框这样的连续点（不适合提取特征点？），直接法比特征点法和光流法效果要好。
	对于三维空间中的一个关键点P，在相邻两个相机中的投影分别记为p1，p2。直接法的思路是根据初始相机的位姿估计值，结合p1的位置（似乎也可以取p1点附近的一个方块，假设在两个图像中p1点附近的像素点发生了相同形式的运动），计算得到p2的位置。如果相机的位姿矩阵不够好，那么p1和p2表现的差别可能比较大，这样就可以使用一个优化问题来优化相机的位姿矩阵。与特征点法使用最小化重投影误差不同，直接法使用最小化光度误差进行优化，即使P点的两个投影像素的亮度误差达到最小。这样做的理论前提仍然是基于灰度不变假设。在数学推导中，需要注意的是直接法优化的是相机的运动矩阵R和t，而不像光流法那样优化的是特征点，即“自变量”的选取发生了改变。
	在直接法的数学推导过程中，可以发现，在图像梯度不明显的地方，对相机运动的估计贡献比较小。

8.6  直接法的优缺点
	优点在8.5中已经讨论过。直接法也有一些缺点，如灰度不变难以满足，容易受到曝光和模糊的影响；单像素区分性差；图像非凸等。

8.6  直接法分类
	假设P深度已知，根据P点的来源可以对直接法进行分类：
	1.P点来自稀疏关键点，则称为稀疏直接法。通常使用数百至上千个关键点，并且类似于LK光流法假设关键点周围的像素是不变的。由于直接法不必计算描述子，并且使用的像素点较少，因此速度最快，但只能用于计算稀疏的重构；
	2.P点来自部分像素。在数学推导中可以看到，如果当前像素的梯度为0，那么就不会对运动增量有任何贡献，因此梯度值为0（或梯度变化不明显）的像素可以舍弃。这种方法称为半稠密（Semi-Dense）直接法，可以重构一个半稠密的三维结构。
	3.若P点为所有像素，那么称为稠密直接法。稠密重构需要计算所有像素点（一般几十万到上百万个），因此不能在CPU上进行实时运算，需要GPU加速。但是对于梯度变化不明显的像素点，在运动估计中不会有太大贡献，并且在重构时也会难以估计其位置。
	由此可以看到，从稀疏重建一直到稠密重建，都可以使用直接法。具体用哪种方法需要视情况而定，稀疏直接法可以快速求解相机位姿，稠密直接法可以建立完整地图。